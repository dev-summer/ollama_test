name: Code Review
on: pull_request
jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install transformers torch requests

      - name: Load Review Prompt
        id: load_prompt
        run: |
          PROMPT=$(cat review_prompt.md)
          echo "prompt=$PROMPT" >> $GITHUB_OUTPUT

      - name: Extract pull request diff
        id: get_diff
        run: |
          DIFF=$(git diff origin/develop...HEAD)
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

      - name: Run Code Review with Hugging Face Model
        id: review_code
        run: |
          python3 << EOL
          from transformers import pipeline
          review_model = pipeline("text-generation", model="Qwen/Qwen2.5-Coder-7B-Instruct")
          diff = "${{ steps.get_diff.outputs.diff }}"
          review_prompt = f"Review the following code changes and provide feedback:\n\n{diff}"
          review_comment = review_model(review_prompt, max_length=500, num_return_sequences=1)[0]['generated_text']
          with open("review_comment.txt", "w") as file:
              file.write(review_comment)
          EOL

      - name: Add comment to Pull Request
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('review_comment.txt', 'utf-8');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            })
